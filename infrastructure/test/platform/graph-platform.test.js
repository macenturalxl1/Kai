"use strict";
/*
 * Copyright 2020 Crown Copyright
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = require("@aws-cdk/assert");
const cdk = require("@aws-cdk/core");
const platform = require("../../lib/platform/graph-platform");
test("EKS cluster is created", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    new platform.GraphPlatForm(stack, "TestPlatform");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("Custom::AWSCDK-EKS-Cluster"));
});
test("Node group is created", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    new platform.GraphPlatForm(stack, "TestPlatform");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::EKS::Nodegroup", {
        InstanceTypes: [
            "t3.medium"
        ],
        ScalingConfig: {
            "DesiredSize": 2,
            "MaxSize": 10,
            "MinSize": 1
        }
    }));
});
test("Node group is created with a desired instance type", () => {
    // Given
    const stack = new cdk.Stack();
    stack.node.setContext("clusterNodegroup", { "instanceType": "m5.large" });
    // When
    new platform.GraphPlatForm(stack, "TestPlatform");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::EKS::Nodegroup", {
        InstanceTypes: [
            "m5.large"
        ]
    }));
});
test("Node group is created with a desired sizes", () => {
    // Given
    const stack = new cdk.Stack();
    stack.node.setContext("clusterNodegroup", { "desiredSize": 5, "minSize": 3, "maxSize": 100 });
    // When
    new platform.GraphPlatForm(stack, "TestPlatform");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::EKS::Nodegroup", {
        ScalingConfig: {
            DesiredSize: 5,
            MinSize: 3,
            MaxSize: 100
        }
    }));
});
test("Node group is created when config is string", () => {
    // Given
    const stack = new cdk.Stack();
    stack.node.setContext("clusterNodegroup", "{ \"desiredSize\": 4, \"minSize\": 2, \"maxSize\": 30, \"instanceType\": \"m5.large\" }");
    // When
    new platform.GraphPlatForm(stack, "TestPlatform");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::EKS::Nodegroup", {
        InstanceTypes: [
            "m5.large"
        ],
        ScalingConfig: {
            DesiredSize: 4,
            MinSize: 2,
            MaxSize: 30
        }
    }));
});
test("Should throw error when cluster config is the wrong type", () => {
    // Given
    const stack = new cdk.Stack();
    // When 
    stack.node.setContext("clusterNodegroup", { "desiredSize": "5" });
    // Then
    expect(() => { new platform.GraphPlatForm(stack, "TestPlatform"); }).toThrowError();
});
test("Should merge any configuration specified with the default configuration", () => {
    // Given
    const stack = new cdk.Stack();
    stack.node.setContext("clusterNodegroup", { "desiredSize": 5, "minSize": 3 });
    // When
    new platform.GraphPlatForm(stack, "TestPlatform");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::EKS::Nodegroup", {
        InstanceTypes: [
            "t3.medium"
        ],
        ScalingConfig: {
            DesiredSize: 5,
            MinSize: 3,
            MaxSize: 10
        }
    }));
});
test("The ALB ingress controller is deployed on the kube-system namespace", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    new platform.GraphPlatForm(stack, "TestPlatform");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("Custom::AWSCDK-EKS-HelmChart", {
        "Chart": "aws-alb-ingress-controller",
        "Namespace": "kube-system",
        "Repository": "http://storage.googleapis.com/kubernetes-charts-incubator"
    }));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGgtcGxhdGZvcm0udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdyYXBoLXBsYXRmb3JtLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7OztHQWNHOztBQUVILDRDQUFvRTtBQUNwRSxxQ0FBcUM7QUFDckMsOERBQThEO0FBRTlELElBQUksQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7SUFDaEMsUUFBUTtJQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBRTlCLE9BQU87SUFDUCxJQUFJLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBRWxELE9BQU87SUFDUCxlQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLHFCQUFZLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFDO0FBQ3BFLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUMvQixRQUFRO0lBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFOUIsT0FBTztJQUNQLElBQUksUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFFbEQsT0FBTztJQUNQLGVBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMscUJBQVksQ0FBQyxxQkFBcUIsRUFBRTtRQUNwRCxhQUFhLEVBQUU7WUFDWCxXQUFXO1NBQ2Q7UUFDRCxhQUFhLEVBQUU7WUFDWCxhQUFhLEVBQUUsQ0FBQztZQUNoQixTQUFTLEVBQUUsRUFBRTtZQUNiLFNBQVMsRUFBRSxDQUFDO1NBQ2Y7S0FDSixDQUFDLENBQUMsQ0FBQztBQUNSLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLG9EQUFvRCxFQUFFLEdBQUcsRUFBRTtJQUM1RCxRQUFRO0lBQ1IsTUFB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LENBQUMsQ0FBQztJQUU5RSxPQUFPO0lBQ1AsSUFBSSxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxjQUFjLENBQUMsQ0FBQztJQUVsRCxPQUFPO0lBQ1AsZUFBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxxQkFBWSxDQUFDLHFCQUFxQixFQUFFO1FBQ3BELGFBQWEsRUFBRTtZQUNYLFdBQVc7U0FDZDtRQUNELGFBQWEsRUFBRTtZQUNYLFdBQVcsRUFBRSxDQUFDO1lBQ2QsT0FBTyxFQUFFLENBQUM7WUFDVixPQUFPLEVBQUUsRUFBRTtTQUNkO0tBQ0osQ0FBQyxDQUFDLENBQUM7QUFDUixDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxxRUFBcUUsRUFBRSxHQUFHLEVBQUU7SUFDN0UsUUFBUTtJQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBRTlCLE9BQU87SUFDUCxJQUFJLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBRWxELE9BQU87SUFDUCxlQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLHFCQUFZLENBQUMsOEJBQThCLEVBQUU7UUFDN0QsT0FBTyxFQUFFLDRCQUE0QjtRQUNyQyxXQUFXLEVBQUUsYUFBYTtRQUMxQixZQUFZLEVBQUUsMkRBQTJEO0tBQzVFLENBQUMsQ0FBQyxDQUFDO0FBQ1IsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMjAgQ3Jvd24gQ29weXJpZ2h0XG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGV4cGVjdCBhcyBleHBlY3RDREssIGhhdmVSZXNvdXJjZSB9IGZyb20gXCJAYXdzLWNkay9hc3NlcnRcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgcGxhdGZvcm0gZnJvbSBcIi4uLy4uL2xpYi9wbGF0Zm9ybS9ncmFwaC1wbGF0Zm9ybVwiO1xuXG50ZXN0KFwiRUtTIGNsdXN0ZXIgaXMgY3JlYXRlZFwiLCAoKSA9PiB7XG4gICAgLy8gR2l2ZW5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIC8vIFdoZW5cbiAgICBuZXcgcGxhdGZvcm0uR3JhcGhQbGF0Rm9ybShzdGFjaywgXCJUZXN0UGxhdGZvcm1cIik7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJDdXN0b206OkFXU0NESy1FS1MtQ2x1c3RlclwiKSk7XG59KTtcblxudGVzdChcIk5vZGUgZ3JvdXAgaXMgY3JlYXRlZFwiLCAoKSA9PiB7XG4gICAgLy8gR2l2ZW5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIC8vIFdoZW5cbiAgICBuZXcgcGxhdGZvcm0uR3JhcGhQbGF0Rm9ybShzdGFjaywgXCJUZXN0UGxhdGZvcm1cIik7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OkVLUzo6Tm9kZWdyb3VwXCIsIHtcbiAgICAgICAgSW5zdGFuY2VUeXBlczogWyBcbiAgICAgICAgICAgIFwidDMubWVkaXVtXCJcbiAgICAgICAgXSxcbiAgICAgICAgU2NhbGluZ0NvbmZpZzoge1xuICAgICAgICAgICAgXCJEZXNpcmVkU2l6ZVwiOiAyLFxuICAgICAgICAgICAgXCJNYXhTaXplXCI6IDEwLFxuICAgICAgICAgICAgXCJNaW5TaXplXCI6IDFcbiAgICAgICAgfVxuICAgIH0pKTtcbn0pO1xuXG50ZXN0KFwiTm9kZSBncm91cCBpcyBjcmVhdGVkIHdpdGggYSBkZXNpcmVkIGluc3RhbmNlIHR5cGVcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgc3RhY2subm9kZS5zZXRDb250ZXh0KFwiY2x1c3Rlck5vZGVncm91cFwiLCB7IFwiaW5zdGFuY2VUeXBlXCI6IFwibTUubGFyZ2VcIiB9KTtcblxuICAgIC8vIFdoZW5cbiAgICBuZXcgcGxhdGZvcm0uR3JhcGhQbGF0Rm9ybShzdGFjaywgXCJUZXN0UGxhdGZvcm1cIik7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OkVLUzo6Tm9kZWdyb3VwXCIsIHtcbiAgICAgICAgSW5zdGFuY2VUeXBlczogWyBcbiAgICAgICAgICAgIFwibTUubGFyZ2VcIlxuICAgICAgICBdXG4gICAgfSkpO1xufSk7XG5cbnRlc3QoXCJOb2RlIGdyb3VwIGlzIGNyZWF0ZWQgd2l0aCBhIGRlc2lyZWQgc2l6ZXNcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgc3RhY2subm9kZS5zZXRDb250ZXh0KFwiY2x1c3Rlck5vZGVncm91cFwiLCB7IFwiZGVzaXJlZFNpemVcIjogNSwgXCJtaW5TaXplXCI6IDMsIFwibWF4U2l6ZVwiOiAxMDAgfSk7XG5cbiAgICAvLyBXaGVuXG4gICAgbmV3IHBsYXRmb3JtLkdyYXBoUGxhdEZvcm0oc3RhY2ssIFwiVGVzdFBsYXRmb3JtXCIpO1xuXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKFwiQVdTOjpFS1M6Ok5vZGVncm91cFwiLCB7XG4gICAgICAgIFNjYWxpbmdDb25maWc6IHtcbiAgICAgICAgICAgIERlc2lyZWRTaXplOiA1LFxuICAgICAgICAgICAgTWluU2l6ZTogMyxcbiAgICAgICAgICAgIE1heFNpemU6IDEwMFxuICAgICAgICB9XG4gICAgfSkpO1xufSk7XG5cbnRlc3QoXCJOb2RlIGdyb3VwIGlzIGNyZWF0ZWQgd2hlbiBjb25maWcgaXMgc3RyaW5nXCIsICgpID0+IHtcbiAgICAvLyBHaXZlblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIHN0YWNrLm5vZGUuc2V0Q29udGV4dChcImNsdXN0ZXJOb2RlZ3JvdXBcIiwgXCJ7IFxcXCJkZXNpcmVkU2l6ZVxcXCI6IDQsIFxcXCJtaW5TaXplXFxcIjogMiwgXFxcIm1heFNpemVcXFwiOiAzMCwgXFxcImluc3RhbmNlVHlwZVxcXCI6IFxcXCJtNS5sYXJnZVxcXCIgfVwiKTtcblxuICAgIC8vIFdoZW5cbiAgICBuZXcgcGxhdGZvcm0uR3JhcGhQbGF0Rm9ybShzdGFjaywgXCJUZXN0UGxhdGZvcm1cIik7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OkVLUzo6Tm9kZWdyb3VwXCIsIHtcbiAgICAgICAgSW5zdGFuY2VUeXBlczogWyBcbiAgICAgICAgICAgIFwibTUubGFyZ2VcIlxuICAgICAgICBdLFxuICAgICAgICBTY2FsaW5nQ29uZmlnOiB7XG4gICAgICAgICAgICBEZXNpcmVkU2l6ZTogNCxcbiAgICAgICAgICAgIE1pblNpemU6IDIsXG4gICAgICAgICAgICBNYXhTaXplOiAzMFxuICAgICAgICB9XG4gICAgfSkpO1xufSk7XG5cbnRlc3QoXCJTaG91bGQgdGhyb3cgZXJyb3Igd2hlbiBjbHVzdGVyIGNvbmZpZyBpcyB0aGUgd3JvbmcgdHlwZVwiLCAoKSA9PiB7XG4gICAgLy8gR2l2ZW5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICAvLyBXaGVuIFxuICAgIHN0YWNrLm5vZGUuc2V0Q29udGV4dChcImNsdXN0ZXJOb2RlZ3JvdXBcIiwgeyBcImRlc2lyZWRTaXplXCI6IFwiNVwiIH0pO1xuXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdCgoKSA9PiB7IG5ldyBwbGF0Zm9ybS5HcmFwaFBsYXRGb3JtKHN0YWNrLCBcIlRlc3RQbGF0Zm9ybVwiKTt9ICkudG9UaHJvd0Vycm9yKCk7XG59KTtcblxudGVzdChcIlNob3VsZCBtZXJnZSBhbnkgY29uZmlndXJhdGlvbiBzcGVjaWZpZWQgd2l0aCB0aGUgZGVmYXVsdCBjb25maWd1cmF0aW9uXCIsICgpID0+IHtcbiAgICAvLyBHaXZlblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIHN0YWNrLm5vZGUuc2V0Q29udGV4dChcImNsdXN0ZXJOb2RlZ3JvdXBcIiwgeyBcImRlc2lyZWRTaXplXCI6IDUsIFwibWluU2l6ZVwiOiAzIH0pO1xuXG4gICAgLy8gV2hlblxuICAgIG5ldyBwbGF0Zm9ybS5HcmFwaFBsYXRGb3JtKHN0YWNrLCBcIlRlc3RQbGF0Zm9ybVwiKTtcblxuICAgIC8vIFRoZW5cbiAgICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZShcIkFXUzo6RUtTOjpOb2RlZ3JvdXBcIiwge1xuICAgICAgICBJbnN0YW5jZVR5cGVzOiBbXG4gICAgICAgICAgICBcInQzLm1lZGl1bVwiXG4gICAgICAgIF0sXG4gICAgICAgIFNjYWxpbmdDb25maWc6IHtcbiAgICAgICAgICAgIERlc2lyZWRTaXplOiA1LFxuICAgICAgICAgICAgTWluU2l6ZTogMyxcbiAgICAgICAgICAgIE1heFNpemU6IDEwXG4gICAgICAgIH1cbiAgICB9KSk7XG59KTtcblxudGVzdChcIlRoZSBBTEIgaW5ncmVzcyBjb250cm9sbGVyIGlzIGRlcGxveWVkIG9uIHRoZSBrdWJlLXN5c3RlbSBuYW1lc3BhY2VcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXaGVuXG4gICAgbmV3IHBsYXRmb3JtLkdyYXBoUGxhdEZvcm0oc3RhY2ssIFwiVGVzdFBsYXRmb3JtXCIpO1xuXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKFwiQ3VzdG9tOjpBV1NDREstRUtTLUhlbG1DaGFydFwiLCB7XG4gICAgICAgIFwiQ2hhcnRcIjogXCJhd3MtYWxiLWluZ3Jlc3MtY29udHJvbGxlclwiLFxuICAgICAgICBcIk5hbWVzcGFjZVwiOiBcImt1YmUtc3lzdGVtXCIsXG4gICAgICAgIFwiUmVwb3NpdG9yeVwiOiBcImh0dHA6Ly9zdG9yYWdlLmdvb2dsZWFwaXMuY29tL2t1YmVybmV0ZXMtY2hhcnRzLWluY3ViYXRvclwiXG4gICAgfSkpO1xufSk7XG4iXX0=