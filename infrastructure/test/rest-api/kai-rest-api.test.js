"use strict";
/*
 * Copyright 2020 Crown Copyright
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = require("@aws-cdk/assert");
const cdk = require("@aws-cdk/core");
const rest = require("../../lib/rest-api/kai-rest-api");
const aws_dynamodb_1 = require("@aws-cdk/aws-dynamodb");
const constants_1 = require("../../lib/constants");
function createRestAPI(stack, id = "Test") {
    const table = new aws_dynamodb_1.Table(stack, "test", {
        partitionKey: { name: "testKey", type: aws_dynamodb_1.AttributeType.STRING }
    });
    return new rest.KaiRestApi(stack, id, {
        "graphTable": table
    });
}
test("should create new REST API", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::ApiGateway::RestApi"));
});
test("The REST API's name should be derived from the parent construct's id", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack, "NameTest");
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::ApiGateway::RestApi", {
        Name: "NameTestRestApi"
    }));
});
test("The Rest API should have a graph resource which can be POSTed to", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::ApiGateway::Resource", {
        PathPart: "graphs"
    }));
    assert_1.expect(stack).to(assert_1.haveResourceLike("AWS::ApiGateway::Method", {
        HttpMethod: "POST",
        ResourceId: {
            Ref: "TestTestRestApigraphs6F3DCBD4"
        },
        RestApiId: {
            Ref: "TestTestRestApiF3AB3CBC"
        }
    }));
});
test("The Graph resource should handle GET requests on it's root", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResourceLike("AWS::ApiGateway::Method", {
        HttpMethod: "GET",
        ResourceId: {
            Ref: "TestTestRestApigraphs6F3DCBD4"
        },
        RestApiId: {
            Ref: "TestTestRestApiF3AB3CBC"
        }
    }));
});
test("The REST API should have a resource which can GET specific graphs", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::ApiGateway::Resource", {
        PathPart: "{graphId}",
        ParentId: {
            "Ref": "TestTestRestApigraphs6F3DCBD4"
        }
    }));
    assert_1.expect(stack).to(assert_1.haveResourceLike("AWS::ApiGateway::Method", {
        HttpMethod: "GET",
        ResourceId: {
            Ref: "TestTestRestApigraphsgraphId0A18A4C6"
        },
        RestApiId: {
            Ref: "TestTestRestApiF3AB3CBC"
        }
    }));
});
test("Should create a lambda function to serve GET requests", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::Lambda::Function", {
        Handler: "get_graph_request.handler"
    }));
});
test("Should allow GetGraphs Lambda to read from backend database", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::IAM::Policy", {
        "PolicyDocument": {
            "Statement": [
                {
                    "Action": [
                        "dynamodb:BatchGetItem",
                        "dynamodb:GetRecords",
                        "dynamodb:GetShardIterator",
                        "dynamodb:Query",
                        "dynamodb:GetItem",
                        "dynamodb:Scan"
                    ],
                    "Effect": "Allow",
                    "Resource": [
                        {
                            "Fn::GetAtt": [
                                "testAF53AC38",
                                "Arn"
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            ],
            "Version": "2012-10-17"
        },
        "PolicyName": "TestGetGraphsHandlerServiceRoleDefaultPolicy233C6E93",
        "Roles": [
            {
                "Ref": "TestGetGraphsHandlerServiceRole2564883C"
            }
        ]
    }));
});
test("The specific Graph resource should handle DELETE requests", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResourceLike("AWS::ApiGateway::Method", {
        HttpMethod: "DELETE",
        ResourceId: {
            Ref: "TestTestRestApigraphsgraphId0A18A4C6"
        },
        RestApiId: {
            Ref: "TestTestRestApiF3AB3CBC"
        }
    }));
});
test("Should create a queue for DeleteGraph messages to be sent to workers", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::SQS::Queue", {
        VisibilityTimeout: constants_1.DELETE_GRAPH_TIMEOUT.toSeconds()
    }));
});
test("Should create a lambda to send messages to the deleteGraph queue", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::Lambda::Function", {
        Handler: "delete_graph_request.handler"
    }));
});
test("Should allow the Delete Graph Lambda to write to the backend database and Send messages to the Queue", () => {
    // Given
    const stack = new cdk.Stack();
    // When
    createRestAPI(stack);
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::IAM::Policy", {
        "PolicyDocument": {
            "Statement": [
                {
                    "Action": [
                        "dynamodb:BatchWriteItem",
                        "dynamodb:PutItem",
                        "dynamodb:UpdateItem",
                        "dynamodb:DeleteItem"
                    ],
                    "Effect": "Allow",
                    "Resource": [
                        {
                            "Fn::GetAtt": [
                                "testAF53AC38",
                                "Arn"
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                {
                    "Action": [
                        "sqs:SendMessage",
                        "sqs:GetQueueAttributes",
                        "sqs:GetQueueUrl"
                    ],
                    "Effect": "Allow",
                    "Resource": {
                        "Fn::GetAtt": [
                            "TestDeleteGraphQueue040902EA",
                            "Arn"
                        ]
                    }
                }
            ],
            "Version": "2012-10-17"
        },
        "PolicyName": "TestDeleteGraphHandlerServiceRoleDefaultPolicyF464B975",
        "Roles": [
            {
                "Ref": "TestDeleteGraphHandlerServiceRole22483873"
            }
        ]
    }));
});
test("should create a queue for AddGraph messages to be sent to workers", () => {
    // Given
    const stack = new cdk.Stack();
    const table = new aws_dynamodb_1.Table(stack, "test", {
        partitionKey: { name: "test", type: aws_dynamodb_1.AttributeType.STRING }
    });
    // When
    new rest.KaiRestApi(stack, "Test", {
        "graphTable": table
    });
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::SQS::Queue", {
        VisibilityTimeout: constants_1.ADD_GRAPH_TIMEOUT.toSeconds()
    }));
});
test("should create lambda to write messages to the Add Graph Queue", () => {
    // Given
    const stack = new cdk.Stack();
    const table = new aws_dynamodb_1.Table(stack, "test", {
        partitionKey: { name: "test", type: aws_dynamodb_1.AttributeType.STRING }
    });
    // When
    new rest.KaiRestApi(stack, "Test", {
        "graphTable": table
    });
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::Lambda::Function", {
        Handler: "add_graph_request.handler"
    }));
});
test("should allow AddGraphLambda to write messages to queue and write to Dynamodb", () => {
    // Given
    const stack = new cdk.Stack();
    const table = new aws_dynamodb_1.Table(stack, "test", {
        partitionKey: { name: "test", type: aws_dynamodb_1.AttributeType.STRING }
    });
    // When
    new rest.KaiRestApi(stack, "Test", {
        "graphTable": table
    });
    // Then
    assert_1.expect(stack).to(assert_1.haveResource("AWS::IAM::Policy", {
        "PolicyDocument": {
            "Statement": [
                {
                    "Action": [
                        "dynamodb:BatchWriteItem",
                        "dynamodb:PutItem",
                        "dynamodb:UpdateItem",
                        "dynamodb:DeleteItem"
                    ],
                    "Effect": "Allow",
                    "Resource": [
                        {
                            "Fn::GetAtt": [
                                "testAF53AC38",
                                "Arn"
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                {
                    "Action": [
                        "sqs:SendMessage",
                        "sqs:GetQueueAttributes",
                        "sqs:GetQueueUrl"
                    ],
                    "Effect": "Allow",
                    "Resource": {
                        "Fn::GetAtt": [
                            "TestAddGraphQueue2C2BD89D",
                            "Arn"
                        ]
                    }
                }
            ],
            "Version": "2012-10-17"
        },
        "PolicyName": "TestAddGraphHandlerServiceRoleDefaultPolicyA73C8E7F",
        "Roles": [
            {
                "Ref": "TestAddGraphHandlerServiceRole6EB73DAD"
            }
        ]
    }));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2FpLXJlc3QtYXBpLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJrYWktcmVzdC1hcGkudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7O0FBRUgsNENBQXNGO0FBQ3RGLHFDQUFxQztBQUNyQyx3REFBd0Q7QUFDeEQsd0RBQTZEO0FBQzdELG1EQUE4RTtBQUU5RSxTQUFTLGFBQWEsQ0FBQyxLQUFnQixFQUFFLEVBQUUsR0FBRyxNQUFNO0lBQ2hELE1BQU0sS0FBSyxHQUFHLElBQUksb0JBQUssQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO1FBQ25DLFlBQVksRUFBRSxFQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLDRCQUFhLENBQUMsTUFBTSxFQUFDO0tBQzlELENBQUMsQ0FBQztJQUVILE9BQU8sSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUU7UUFDbEMsWUFBWSxFQUFFLEtBQUs7S0FDdEIsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUVELElBQUksQ0FBQyw0QkFBNEIsRUFBRSxHQUFHLEVBQUU7SUFDcEMsUUFBUTtJQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBRTlCLE9BQU87SUFDUCxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFckIsT0FBTztJQUNQLGVBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMscUJBQVksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUM7QUFDbEUsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsc0VBQXNFLEVBQUUsR0FBRyxFQUFFO0lBQzlFLFFBQVE7SUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUU5QixPQUFPO0lBQ1AsYUFBYSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQztJQUVqQyxP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QUFLO0tBQ3RCLENBQUMsQ0FBQztJQUVILE9BQU87SUFDUCxlQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLHFCQUFZLENBQUMsa0JBQWtCLEVBQUU7UUFDakQsZ0JBQWdCLEVBQUU7WUFDZCxXQUFXLEVBQUU7Z0JBQ1Q7b0JBQ0ksUUFBUSxFQUFFO3dCQUNOLHlCQUF5Qjt3QkFDekIsa0JBQWtCO3dCQUNsQixxQkFBcUI7d0JBQ3JCLHFCQUFxQjtxQkFDeEI7b0JBQ0QsUUFBUSxFQUFFLE9BQU87b0JBQ2pCLFVBQVUsRUFBRTt3QkFDUjs0QkFDSSxZQUFZLEVBQUU7Z0NBQ1YsY0FBYztnQ0FDZCxLQUFLOzZCQUNSO3lCQUNKO3dCQUNEOzRCQUNJLEtBQUssRUFBRSxjQUFjO3lCQUN4QjtxQkFDSjtpQkFDSjtnQkFDRDtvQkFDSSxRQUFRLEVBQUU7d0JBQ04saUJBQWlCO3dCQUNqQix3QkFBd0I7d0JBQ3hCLGlCQUFpQjtxQkFDcEI7b0JBQ0QsUUFBUSxFQUFFLE9BQU87b0JBQ2pCLFVBQVUsRUFBRTt3QkFDUixZQUFZLEVBQUU7NEJBQ1YsMkJBQTJCOzRCQUMzQixLQUFLO3lCQUNSO3FCQUNKO2lCQUNKO2FBQ0o7WUFDRCxTQUFTLEVBQUUsWUFBWTtTQUMxQjtRQUNELFlBQVksRUFBRSxxREFBcUQ7UUFDbkUsT0FBTyxFQUFFO1lBQ0w7Z0JBQ0ksS0FBSyxFQUFFLHdDQUF3QzthQUNsRDtTQUNKO0tBQ0osQ0FBQyxDQUFDLENBQUM7QUFDUixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMCBDcm93biBDb3B5cmlnaHRcbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgZXhwZWN0IGFzIGV4cGVjdENESywgaGF2ZVJlc291cmNlLCBoYXZlUmVzb3VyY2VMaWtlIH0gZnJvbSBcIkBhd3MtY2RrL2Fzc2VydFwiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyByZXN0IGZyb20gXCIuLi8uLi9saWIvcmVzdC1hcGkva2FpLXJlc3QtYXBpXCI7XG5pbXBvcnQgeyBUYWJsZSwgQXR0cmlidXRlVHlwZSB9IGZyb20gXCJAYXdzLWNkay9hd3MtZHluYW1vZGJcIjtcbmltcG9ydCB7IEFERF9HUkFQSF9USU1FT1VULCBERUxFVEVfR1JBUEhfVElNRU9VVCB9IGZyb20gXCIuLi8uLi9saWIvY29uc3RhbnRzXCI7XG5cbmZ1bmN0aW9uIGNyZWF0ZVJlc3RBUEkoc3RhY2s6IGNkay5TdGFjaywgaWQgPSBcIlRlc3RcIik6IHJlc3QuS2FpUmVzdEFwaSB7XG4gICAgY29uc3QgdGFibGUgPSBuZXcgVGFibGUoc3RhY2ssIFwidGVzdFwiLCB7XG4gICAgICAgIHBhcnRpdGlvbktleToge25hbWU6IFwidGVzdEtleVwiLCB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklOR31cbiAgICB9KTtcblxuICAgIHJldHVybiBuZXcgcmVzdC5LYWlSZXN0QXBpKHN0YWNrLCBpZCwge1xuICAgICAgICBcImdyYXBoVGFibGVcIjogdGFibGVcbiAgICB9KTtcbn1cblxudGVzdChcInNob3VsZCBjcmVhdGUgbmV3IFJFU1QgQVBJXCIsICgpID0+IHtcbiAgICAvLyBHaXZlblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgLy8gV2hlblxuICAgIGNyZWF0ZVJlc3RBUEkoc3RhY2spO1xuXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKFwiQVdTOjpBcGlHYXRld2F5OjpSZXN0QXBpXCIpKTtcbn0pO1xuXG50ZXN0KFwiVGhlIFJFU1QgQVBJJ3MgbmFtZSBzaG91bGQgYmUgZGVyaXZlZCBmcm9tIHRoZSBwYXJlbnQgY29uc3RydWN0J3MgaWRcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgXG4gICAgLy8gV2hlblxuICAgIGNyZWF0ZVJlc3RBUEkoc3RhY2ssIFwiTmFtZVRlc3RcIik7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OkFwaUdhdGV3YXk6OlJlc3RBcGlcIiwge1xuICAgICAgICBOYW1lOiBcIk5hbWVUZXN0UmVzdEFwaVwiXG4gICAgfSkpO1xufSk7XG5cbnRlc3QoXCJUaGUgUmVzdCBBUEkgc2hvdWxkIGhhdmUgYSBncmFwaCByZXNvdXJjZSB3aGljaCBjYW4gYmUgUE9TVGVkIHRvXCIsICgpID0+IHtcbiAgICAvLyBHaXZlblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIFxuICAgIC8vIFdoZW5cbiAgICBjcmVhdGVSZXN0QVBJKHN0YWNrKTtcbiBcbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OkFwaUdhdGV3YXk6OlJlc291cmNlXCIsIHtcbiAgICAgICAgUGF0aFBhcnQ6IFwiZ3JhcGhzXCJcbiAgICB9KSk7XG5cbiAgICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZUxpa2UoXCJBV1M6OkFwaUdhdGV3YXk6Ok1ldGhvZFwiLCB7XG4gICAgICAgIEh0dHBNZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICBSZXNvdXJjZUlkOiB7XG4gICAgICAgICAgICBSZWY6IFwiVGVzdFRlc3RSZXN0QXBpZ3JhcGhzNkYzRENCRDRcIlxuICAgICAgICB9LFxuICAgICAgICBSZXN0QXBpSWQ6IHtcbiAgICAgICAgICAgIFJlZjogXCJUZXN0VGVzdFJlc3RBcGlGM0FCM0NCQ1wiXG4gICAgICAgIH1cbiAgICB9KSk7XG59KTtcblxudGVzdChcIlRoZSBHcmFwaCByZXNvdXJjZSBzaG91bGQgaGFuZGxlIEdFVCByZXF1ZXN0cyBvbiBpdCdzIHJvb3RcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgIFxuICAgIC8vIFdoZW5cbiAgICBjcmVhdGVSZXN0QVBJKHN0YWNrKTtcblxuICAgIC8vIFRoZW5cbiAgICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZUxpa2UoXCJBV1M6OkFwaUdhdGV3YXk6Ok1ldGhvZFwiLCB7XG4gICAgICAgIEh0dHBNZXRob2Q6IFwiR0VUXCIsXG4gICAgICAgIFJlc291cmNlSWQ6IHtcbiAgICAgICAgICAgIFJlZjogXCJUZXN0VGVzdFJlc3RBcGlncmFwaHM2RjNEQ0JENFwiXG4gICAgICAgIH0sXG4gICAgICAgIFJlc3RBcGlJZDoge1xuICAgICAgICAgICAgUmVmOiBcIlRlc3RUZXN0UmVzdEFwaUYzQUIzQ0JDXCJcbiAgICAgICAgfVxuICAgIH0pKTtcbn0pO1xuXG50ZXN0KFwiVGhlIFJFU1QgQVBJIHNob3VsZCBoYXZlIGEgcmVzb3VyY2Ugd2hpY2ggY2FuIEdFVCBzcGVjaWZpYyBncmFwaHNcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICBcbiAgICAvLyBXaGVuXG4gICAgY3JlYXRlUmVzdEFQSShzdGFjayk7XG4gXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKFwiQVdTOjpBcGlHYXRld2F5OjpSZXNvdXJjZVwiLCB7XG4gICAgICAgIFBhdGhQYXJ0OiBcIntncmFwaElkfVwiLFxuICAgICAgICBQYXJlbnRJZDoge1xuICAgICAgICAgICAgXCJSZWZcIjogXCJUZXN0VGVzdFJlc3RBcGlncmFwaHM2RjNEQ0JENFwiXG4gICAgICAgIH1cbiAgICB9KSk7XG5cbiAgICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZUxpa2UoXCJBV1M6OkFwaUdhdGV3YXk6Ok1ldGhvZFwiLCB7XG4gICAgICAgIEh0dHBNZXRob2Q6IFwiR0VUXCIsXG4gICAgICAgIFJlc291cmNlSWQ6IHtcbiAgICAgICAgICAgIFJlZjogXCJUZXN0VGVzdFJlc3RBcGlncmFwaHNncmFwaElkMEExOEE0QzZcIlxuICAgICAgICB9LFxuICAgICAgICBSZXN0QXBpSWQ6IHtcbiAgICAgICAgICAgIFJlZjogXCJUZXN0VGVzdFJlc3RBcGlGM0FCM0NCQ1wiXG4gICAgICAgIH1cbiAgICB9KSk7XG59KTtcblxudGVzdChcIlNob3VsZCBjcmVhdGUgYSBsYW1iZGEgZnVuY3Rpb24gdG8gc2VydmUgR0VUIHJlcXVlc3RzXCIsICgpID0+IHtcbiAgICAvLyBHaXZlblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgICAgICBcbiAgICAvLyBXaGVuXG4gICAgY3JlYXRlUmVzdEFQSShzdGFjayk7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OkxhbWJkYTo6RnVuY3Rpb25cIiwge1xuICAgICAgICBIYW5kbGVyOiBcImdldF9ncmFwaF9yZXF1ZXN0LmhhbmRsZXJcIlxuICAgIH0pKTtcbn0pO1xuXG50ZXN0KFwiU2hvdWxkIGFsbG93IEdldEdyYXBocyBMYW1iZGEgdG8gcmVhZCBmcm9tIGJhY2tlbmQgZGF0YWJhc2VcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXaGVuXG4gICAgY3JlYXRlUmVzdEFQSShzdGFjayk7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OklBTTo6UG9saWN5XCIsIHtcbiAgICAgICAgXCJQb2xpY3lEb2N1bWVudFwiOiB7XG4gICAgICAgICAgICBcIlN0YXRlbWVudFwiOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBcIkFjdGlvblwiOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICBcImR5bmFtb2RiOkJhdGNoR2V0SXRlbVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJkeW5hbW9kYjpHZXRSZWNvcmRzXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImR5bmFtb2RiOkdldFNoYXJkSXRlcmF0b3JcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZHluYW1vZGI6UXVlcnlcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZHluYW1vZGI6R2V0SXRlbVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJkeW5hbW9kYjpTY2FuXCJcbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgICAgICAgICBcIlJlc291cmNlXCI6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkZuOjpHZXRBdHRcIjogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInRlc3RBRjUzQUMzOFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkFyblwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlJlZlwiOiBcIkFXUzo6Tm9WYWx1ZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgXCJWZXJzaW9uXCI6IFwiMjAxMi0xMC0xN1wiXG4gICAgICAgIH0sXG4gICAgICAgIFwiUG9saWN5TmFtZVwiOiBcIlRlc3RHZXRHcmFwaHNIYW5kbGVyU2VydmljZVJvbGVEZWZhdWx0UG9saWN5MjMzQzZFOTNcIixcbiAgICAgICAgXCJSb2xlc1wiOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgXCJSZWZcIjogXCJUZXN0R2V0R3JhcGhzSGFuZGxlclNlcnZpY2VSb2xlMjU2NDg4M0NcIlxuICAgICAgICAgICAgfVxuICAgICAgICBdXG4gICAgfSkpO1xufSk7XG5cbnRlc3QoXCJUaGUgc3BlY2lmaWMgR3JhcGggcmVzb3VyY2Ugc2hvdWxkIGhhbmRsZSBERUxFVEUgcmVxdWVzdHNcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgIFxuICAgIC8vIFdoZW5cbiAgICBjcmVhdGVSZXN0QVBJKHN0YWNrKTtcblxuICAgIC8vIFRoZW5cbiAgICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZUxpa2UoXCJBV1M6OkFwaUdhdGV3YXk6Ok1ldGhvZFwiLCB7XG4gICAgICAgIEh0dHBNZXRob2Q6IFwiREVMRVRFXCIsXG4gICAgICAgIFJlc291cmNlSWQ6IHtcbiAgICAgICAgICAgIFJlZjogXCJUZXN0VGVzdFJlc3RBcGlncmFwaHNncmFwaElkMEExOEE0QzZcIlxuICAgICAgICB9LFxuICAgICAgICBSZXN0QXBpSWQ6IHtcbiAgICAgICAgICAgIFJlZjogXCJUZXN0VGVzdFJlc3RBcGlGM0FCM0NCQ1wiXG4gICAgICAgIH1cbiAgICB9KSk7XG59KTtcblxudGVzdChcIlNob3VsZCBjcmVhdGUgYSBxdWV1ZSBmb3IgRGVsZXRlR3JhcGggbWVzc2FnZXMgdG8gYmUgc2VudCB0byB3b3JrZXJzXCIsICgpID0+IHtcbiAgICAvLyBHaXZlblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgLy8gV2hlblxuICAgIGNyZWF0ZVJlc3RBUEkoc3RhY2spO1xuXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKFwiQVdTOjpTUVM6OlF1ZXVlXCIsIHtcbiAgICAgICAgVmlzaWJpbGl0eVRpbWVvdXQ6IERFTEVURV9HUkFQSF9USU1FT1VULnRvU2Vjb25kcygpXG4gICAgfSkpO1xufSk7XG5cbnRlc3QoXCJTaG91bGQgY3JlYXRlIGEgbGFtYmRhIHRvIHNlbmQgbWVzc2FnZXMgdG8gdGhlIGRlbGV0ZUdyYXBoIHF1ZXVlXCIsICgpID0+IHtcbiAgICAvLyBHaXZlblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgLy8gV2hlblxuICAgIGNyZWF0ZVJlc3RBUEkoc3RhY2spO1xuXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKFwiQVdTOjpMYW1iZGE6OkZ1bmN0aW9uXCIsIHtcbiAgICAgICAgSGFuZGxlcjogXCJkZWxldGVfZ3JhcGhfcmVxdWVzdC5oYW5kbGVyXCJcbiAgICB9KSk7XG59KTtcblxudGVzdChcIlNob3VsZCBhbGxvdyB0aGUgRGVsZXRlIEdyYXBoIExhbWJkYSB0byB3cml0ZSB0byB0aGUgYmFja2VuZCBkYXRhYmFzZSBhbmQgU2VuZCBtZXNzYWdlcyB0byB0aGUgUXVldWVcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXaGVuXG4gICAgY3JlYXRlUmVzdEFQSShzdGFjayk7XG5cbiAgICAvLyBUaGVuXG4gICAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoXCJBV1M6OklBTTo6UG9saWN5XCIsIHtcbiAgICAgICAgXCJQb2xpY3lEb2N1bWVudFwiOiB7XG4gICAgICAgICAgICBcIlN0YXRlbWVudFwiOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBcIkFjdGlvblwiOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICBcImR5bmFtb2RiOkJhdGNoV3JpdGVJdGVtXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImR5bmFtb2RiOlB1dEl0ZW1cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZHluYW1vZGI6VXBkYXRlSXRlbVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJkeW5hbW9kYjpEZWxldGVJdGVtXCJcbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgICAgICAgICBcIlJlc291cmNlXCI6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkZuOjpHZXRBdHRcIjogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInRlc3RBRjUzQUMzOFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkFyblwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlJlZlwiOiBcIkFXUzo6Tm9WYWx1ZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgXCJBY3Rpb25cIjogW1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJzcXM6U2VuZE1lc3NhZ2VcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwic3FzOkdldFF1ZXVlQXR0cmlidXRlc1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJzcXM6R2V0UXVldWVVcmxcIlxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBcIkVmZmVjdFwiOiBcIkFsbG93XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiUmVzb3VyY2VcIjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJGbjo6R2V0QXR0XCI6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlRlc3REZWxldGVHcmFwaFF1ZXVlMDQwOTAyRUFcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkFyblwiXG4gICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgXCJWZXJzaW9uXCI6IFwiMjAxMi0xMC0xN1wiXG4gICAgICAgIH0sXG4gICAgICAgIFwiUG9saWN5TmFtZVwiOiBcIlRlc3REZWxldGVHcmFwaEhhbmRsZXJTZXJ2aWNlUm9sZURlZmF1bHRQb2xpY3lGNDY0Qjk3NVwiLFxuICAgICAgICBcIlJvbGVzXCI6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBcIlJlZlwiOiBcIlRlc3REZWxldGVHcmFwaEhhbmRsZXJTZXJ2aWNlUm9sZTIyNDgzODczXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgIH0pKTtcbn0pO1xuXG50ZXN0KFwic2hvdWxkIGNyZWF0ZSBhIHF1ZXVlIGZvciBBZGRHcmFwaCBtZXNzYWdlcyB0byBiZSBzZW50IHRvIHdvcmtlcnNcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgY29uc3QgdGFibGUgPSBuZXcgVGFibGUoc3RhY2ssIFwidGVzdFwiLCB7XG4gICAgICAgIHBhcnRpdGlvbktleToge25hbWU6IFwidGVzdFwiLCB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklOR31cbiAgICB9KTtcblxuICAgIC8vIFdoZW5cbiAgICBuZXcgcmVzdC5LYWlSZXN0QXBpKHN0YWNrLCBcIlRlc3RcIiwge1xuICAgICAgICBcImdyYXBoVGFibGVcIjogdGFibGVcbiAgICB9KTtcblxuICAgIC8vIFRoZW5cbiAgICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZShcIkFXUzo6U1FTOjpRdWV1ZVwiLCB7XG4gICAgICAgIFZpc2liaWxpdHlUaW1lb3V0OiBBRERfR1JBUEhfVElNRU9VVC50b1NlY29uZHMoKVxuICAgIH0pKTtcbn0pO1xuXG50ZXN0KFwic2hvdWxkIGNyZWF0ZSBsYW1iZGEgdG8gd3JpdGUgbWVzc2FnZXMgdG8gdGhlIEFkZCBHcmFwaCBRdWV1ZVwiLCAoKSA9PiB7XG4gICAgLy8gR2l2ZW5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICBjb25zdCB0YWJsZSA9IG5ldyBUYWJsZShzdGFjaywgXCJ0ZXN0XCIsIHtcbiAgICAgICAgcGFydGl0aW9uS2V5OiB7bmFtZTogXCJ0ZXN0XCIsIHR5cGU6IEF0dHJpYnV0ZVR5cGUuU1RSSU5HfVxuICAgIH0pO1xuXG4gICAgLy8gV2hlblxuICAgIG5ldyByZXN0LkthaVJlc3RBcGkoc3RhY2ssIFwiVGVzdFwiLCB7XG4gICAgICAgIFwiZ3JhcGhUYWJsZVwiOiB0YWJsZVxuICAgIH0pO1xuXG4gICAgLy8gVGhlblxuICAgIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKFwiQVdTOjpMYW1iZGE6OkZ1bmN0aW9uXCIsIHtcbiAgICAgICAgSGFuZGxlcjogXCJhZGRfZ3JhcGhfcmVxdWVzdC5oYW5kbGVyXCJcbiAgICB9KSk7XG59KTtcblxudGVzdChcInNob3VsZCBhbGxvdyBBZGRHcmFwaExhbWJkYSB0byB3cml0ZSBtZXNzYWdlcyB0byBxdWV1ZSBhbmQgd3JpdGUgdG8gRHluYW1vZGJcIiwgKCkgPT4ge1xuICAgIC8vIEdpdmVuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgY29uc3QgdGFibGUgPSBuZXcgVGFibGUoc3RhY2ssIFwidGVzdFwiLCB7XG4gICAgICAgIHBhcnRpdGlvbktleToge25hbWU6IFwidGVzdFwiLCB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklOR31cbiAgICB9KTtcblxuICAgIC8vIFdoZW5cbiAgICBuZXcgcmVzdC5LYWlSZXN0QXBpKHN0YWNrLCBcIlRlc3RcIiwge1xuICAgICAgICBcImdyYXBoVGFibGVcIjogdGFibGVcbiAgICB9KTtcblxuICAgIC8vIFRoZW5cbiAgICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZShcIkFXUzo6SUFNOjpQb2xpY3lcIiwge1xuICAgICAgICBcIlBvbGljeURvY3VtZW50XCI6IHtcbiAgICAgICAgICAgIFwiU3RhdGVtZW50XCI6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwiQWN0aW9uXCI6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZHluYW1vZGI6QmF0Y2hXcml0ZUl0ZW1cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZHluYW1vZGI6UHV0SXRlbVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJkeW5hbW9kYjpVcGRhdGVJdGVtXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcImR5bmFtb2RiOkRlbGV0ZUl0ZW1cIlxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBcIkVmZmVjdFwiOiBcIkFsbG93XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiUmVzb3VyY2VcIjogW1xuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiRm46OkdldEF0dFwiOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidGVzdEFGNTNBQzM4XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQXJuXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiUmVmXCI6IFwiQVdTOjpOb1ZhbHVlXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBcIkFjdGlvblwiOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICBcInNxczpTZW5kTWVzc2FnZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJzcXM6R2V0UXVldWVBdHRyaWJ1dGVzXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcInNxczpHZXRRdWV1ZVVybFwiXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIFwiRWZmZWN0XCI6IFwiQWxsb3dcIixcbiAgICAgICAgICAgICAgICAgICAgXCJSZXNvdXJjZVwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcIkZuOjpHZXRBdHRcIjogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiVGVzdEFkZEdyYXBoUXVldWUyQzJCRDg5RFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQXJuXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBcIlZlcnNpb25cIjogXCIyMDEyLTEwLTE3XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCJQb2xpY3lOYW1lXCI6IFwiVGVzdEFkZEdyYXBoSGFuZGxlclNlcnZpY2VSb2xlRGVmYXVsdFBvbGljeUE3M0M4RTdGXCIsXG4gICAgICAgIFwiUm9sZXNcIjogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFwiUmVmXCI6IFwiVGVzdEFkZEdyYXBoSGFuZGxlclNlcnZpY2VSb2xlNkVCNzNEQURcIlxuICAgICAgICAgICAgfVxuICAgICAgICBdIFxuICAgIH0pKTtcbn0pO1xuIl19